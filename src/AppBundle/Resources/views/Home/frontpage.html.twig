{% extends "::base.html.twig" %}

{% block title %}ElastiCar - automobilių skelbimai{% endblock %}

{% block stylesheets %}
    {{ parent() }}

    <style>
        html {
            overflow: -moz-scrollbars-vertical;
            overflow-y: scroll;
        }

        hr {
            margin-bottom: 30px;
            width: 60%;
        }

        /* Search form */
        .searchBox {
            border: 5px solid #e63a35 !important;
            border-radius: 3px;
        }

        .filters {
            padding: 5px !important;
        }

        .filters select {
            border-radius: 0px !important;
            border-color: #fff;
            background-color: #fff;
            cursor: pointer;
        }

        select:focus {
            outline: none;
        }

        button:focus {
            outline: none !important;
        }

        @media only screen and (min-device-width: 768px) {
            .border-right {
                border-right: 1px solid #FF3956 !important;
            }
        }

        #searchButton {
            margin-top: 3px;
            width: 100%;
            border-radius: 0px;
            background-color: #ed5955;
        }

        /* Provider-info */
        .providers-info h1 {
            font-size: 15px;
            font-weight: 700;
        }

        .providers-info p {
            font-weight: 700;
        }

        /* Providers */
        .providers {
            margin-top: 30px;
            margin-bottom: 60px;
        }

        .providers img {
            max-width: 150px;
            padding: 10px;
        }

        /* Most-popular */
        .most-popular p {
            padding-left: 15px;
            font-size: 22px;
        }

        .most-popular_thumbnail img {
            max-width: 270px;
            max-height: 145px;
        }

        .most-popular_thumbnail {
            box-shadow: none;
            transition: box-shadow 0.3s;
        }

        .most-popular_thumbnail:hover {
            box-shadow: 0 0 3px #ED5955;
        }

        .most-popular_thumbnail p {
            font-size: 20px;
        }

        .most-popular_thumbnail--count {
            color: #808080;
        }

        /* Results */
        #results {
            margin-top: 30px;
        }

        #results .results-row {
            margin-bottom: 15px;
        }

        .classified {
            padding-top: 5px;
            padding-bottom: 5px;
            padding-left: 5px;

            border: 1px solid #808080 !important;
            border-radius: 3px;

            margin-top: 30px;

            cursor: pointer;
        }

        .classified .image img {
            max-width: 100px;
        }

        .classified .link {
            color: #337abb;
            font-size: 22px;
        }

        .classified .classified-icon {
            margin-right: 5px;
            border-radius: 25px;
            color: #FFFFFF;
            height: 25px;
            line-height: 25px;
            text-align: center;
            width: 25px;
            background: #ed5955;
        }

        .classified-param {
            font-size: 17px;
        }

        .classified-params {
            margin-top: 15px;
        }

        .classified .logo img {
            max-width: 100px;
            max-height: 40px;
        }

    </style>
{% endblock %}

{% block navigation %}{% endblock %}


{% block container %}
    <div class="row header">
        <div class="col-md-4 logo">
            <a href="{{ path('homepage') }}">
                <img src="{{ asset('images/logo.png') }}" width="200" alt="ElastiCar"/>
            </a>
        </div>
        <div class="col-md-6"></div>

        <div class="col-md-2">
            <div style="margin: 15px;">
                <a href="{{ path('homepage') }}connect/facebook" id="login" title="Login with Facebook!" onclick="logIn()" style="color: grey; text-decoration: none; display:none;">{{ "Prisijungti"|trans }}</a>
                <a href="{{ path('homepage') }}" id="logout" title="Logout!" onclick="logOut()" style="color: grey; text-decoration: none; display:none;">{{ "Atsijungti"|trans }}</a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12 description text-center">
            {{ "Didžiausia automobilių skelbimų bazė Lietuvoje"|trans }}
        </div>
    </div>

    <div class="row">
        {% include 'AppBundle:Home/Components:search_form.html.twig' %}
    </div>

    <div id="info">
        {% include 'AppBundle:Home/Components:info.html.twig' %}
    </div>

    <div id="results" style="display: none;">

        {% for i in 0..79 %}
            {% set manufacturer = random(['Audi', 'Ford', 'BMW', 'Volkswagen']) %}

            {% if manufacturer == 'Audi' %}
                {% set thumbnail = asset('images/audi.png') %}
                {% set models = ["A3", "A4", "A8", "A6", "TT", "A2", "Q5", "80", "100"] %}
            {% elseif manufacturer == 'Ford' %}
                {% set thumbnail = asset('images/ford.png') %}
                {% set models = ["Fiesta", "Mondeo", "C-MAX", "S-MAX", "B-MAX", "Taurus", "Mustang", "GT", "Focus"] %}
            {% elseif manufacturer == 'BMW' %}
                {% set thumbnail = asset('images/bmw.png') %}
                {% set models = ["E36", "E38", "E39", "E46", "E52", "E70", "325i", "X3", "X5"] %}
            {% elseif manufacturer == 'Volkswagen' %}
                {% set thumbnail = asset('images/vw.png') %}
                {% set models = ["Amarok", "Caddy", "Jetta", "Passat", "Polo", "Routan", "Touareg", "Golf", "Beetle"] %}
            {% endif %}

            {% set model = random(models) %}
            {% set title = manufacturer ~ " " ~ model %}

            {% set gas_type = random(['Dyzelinas', 'Benzinas', 'Dujos']) %}
            {% set gearbox = random(['Mechaninė', 'Automatinė']) %}

            {% set provider = random(['autogidas.lt', 'autoplius.lt', 'automobilis.lt', 'autobilis.lt', 'autotaurage.lt', 'autopagunda.lt', 'autotuk.lt', 'rinka.lt']) %}
            {% if provider == 'autogidas.lt' %}
                {% set provider_logo = asset('images/web_logo/autogidas.svg') %}
            {% elseif provider == 'autoplius.lt' %}
                {% set provider_logo = asset('images/web_logo/autoplius.svg') %}
            {% elseif provider == 'automobilis.lt' %}
                {% set provider_logo = asset('images/web_logo/automobilis.png') %}
            {% elseif provider == 'autobilis.lt' %}
                {% set provider_logo = asset('images/web_logo/autobilis.png') %}
            {% elseif provider == 'autotaurage.lt' %}
                {% set provider_logo = asset('images/web_logo/autotaurage.jpg') %}
            {% elseif provider == 'autopagunda.lt' %}
                {% set provider_logo = asset('images/web_logo/autopagunda.png') %}
            {% elseif provider == 'autotuk.lt' %}
                {% set provider_logo = asset('images/web_logo/autotuk.jpg') %}
            {% elseif provider == 'rinka.lt' %}
                {% set provider_logo = asset('images/web_logo/rinka.png') %}
            {% endif %}


            {% include '@App/Home/Components/classified.html.twig' with {
            'thumbnail': thumbnail,
            'title': title,
            'gas_type': gas_type,
            'gearbox': gearbox,
            'year': random(26) + 1990,
            'kw': random(150) + 70,
            'provider_logo': provider_logo,
            'price': random(15000) + 1000,
            'run': random(300000) + 100000,
            'link': 'http://' ~ provider
            } %}
        {% endfor %}

    </div>

{% endblock %}

{% block javascripts %}
    <script src="{{ asset("js/main-min.js") }}"></script>
    <script>

        function logIn(){
            console.log('wtf');
            localStorage.setItem('loggedIn', true);
        }

        function logOut(){
            console.log('wtf2');
            localStorage.removeItem('loggedIn');
        }

        function isLoggedIn(){
            let status = localStorage.getItem('loggedIn');
            return status;
        }

        $(document).ready(function () {

            if (isLoggedIn()){
                $('#login').hide();
                $('#logout').show();
            } else {
                $('#login').show();
                $('#logout').hide();
            }

            let manufacturerInput = $('#manufacturer');
            let modelInput = $('#model');
            let priceToInput = $('#priceTo');
            let priceFromInput = $('#priceFrom');

            let manufacturer = manufacturerInput.val();
            let model = modelInput.val();
            let priceTo = priceToInput.val();
            let priceFrom = priceFromInput.val();

            $('.shortcut').on('click', function (){

                $(manufacturerInput).val($(this).data('manufacturer'));
                onManufacturerChange($(this).data('manufacturer'));
                $('#info').fadeOut();

                setTimeout(function () {
                    $('#results').fadeIn();
                }, 500);

            });

            manufacturerInput.on('change', function () {
                let value = $(this).val();

                onManufacturerChange(value);
            });

            modelInput.on('change', function (){

                model = $(this).val();

                updateResults();

            });

            $('#searchButton').on('click', function (e) {
                let results = $('#results');
                if (results.css('display') === "block") {

                    updateResults(true);
                } else {
                    $('#info').fadeOut();

                    setTimeout(function () {
                        $('#results').fadeIn();
                    }, 500);
                }

                return false;
            });

            $('#results').on('click', '.classified', function () {
                window.open($(this).data('link'));
            });

            function onManufacturerChange(value){
                model = "Modelis";

                manufacturer = value;

                let models;
                if (manufacturer == 'Audi') {
                    models = ["A3", "A4", "A8", "A6", "TT", "A2", "Q5", "80", "100"];
                } else if (manufacturer == 'Ford') {
                    models = ["Fiesta", "Mondeo", "C-MAX", "S-MAX", "B-MAX", "Taurus", "Mustang", "GT", "Focus"];
                } else if (manufacturer == 'BMW') {
                    models = ["E36", "E38", "E39", "E46", "E52", "E70", "325i", "X3", "X5"];
                } else if (manufacturer == 'Volkswagen') {
                    models = ["Amarok", "Caddy", "Jetta", "Passat", "Polo", "Routan", "Touareg", "Golf", "Beetle"];
                }

                $(modelInput).find('option').remove().end();

                $(modelInput).append("<option hidden>Modelis</option>");
                for (let i = 0; i < models.length; i++) {
                    if($(".classified[data-model*=" + models[i] + "]").length > 0) {
                        $(modelInput).append("<option>" + models[i] + "</option>");
                    }
                }

                updateResults();
            }

            function updateResults(clicked) {

                if (model === "Modelis") {

                    if (manufacturer !== "Markė") {
                        $(".classified[data-manufacturer*=" + manufacturer + "]").show();
                        $(".classified:not([data-manufacturer*=" + manufacturer + "])").hide();
                    }
                } else {
                    $(".classified[data-manufacturer*=" + manufacturer + "][data-model*=" + model + "]").show();
                    $(".classified:not([data-manufacturer*=" + manufacturer + "][data-model*=" + model + "])").hide();
                }

                if (typeof clicked !== "undefined") {
                    $('#results').fadeOut();

                    setTimeout(function () {
                        //$('.classified').shuffle();
                        $('#results').fadeIn("fast", function (){
                            recalculateGrid();
                        });
                    }, 500);
                } else {
                    recalculateGrid();
                }

                return true;
            }

            function recalculateGrid() {

                if (manufacturer !== "Markė") {
                    let visibleAds, nonVisible;

                    if (model === "Modelis") {
                        visibleAds = $(".classified[data-manufacturer*=" + manufacturer + "]");
                        nonVisible = $(".classified:not([data-manufacturer*=" + manufacturer + "])");
                    } else {
                        visibleAds = $(".classified[data-manufacturer*=" + manufacturer + "][data-model*=" + model + "]");
                        nonVisible = $(".classified:not([data-manufacturer*=" + manufacturer + "][data-model*=" + model + "])");
                    }

                    $('.classified').parent().remove();
                    visibleAds.each(function (index) {

                        $('#results').append($(this).parent());

                    });

                    nonVisible.each(function (index) {

                        $('#results').append($(this).parent());

                    });
                }
            }
        });

        (function ($) {

            $.fn.shuffle = function () {

                let allElems = this.get(),
                    getRandom = function (max) {
                        return Math.floor(Math.random() * max);
                    },
                    shuffled = $.map(allElems, function () {
                        let random = getRandom(allElems.length),
                            randEl = $(allElems[random]).clone(true)[0];
                        allElems.splice(random, 1);
                        return randEl;
                    });

                this.each(function (i) {
                    $(this).replaceWith($(shuffled[i]));
                });

                return $(shuffled);

            };

        })(jQuery);

    </script>
{% endblock %}

{% block footer %}{% endblock %}